# 1. EPM Note Engine アプリケーション詳細仕様書 (V1.3)

**ドキュメント名:** `EPM Note Engine Application Specification`

**Version:** 1.3.0 (Final Production Release)

**Author:** Tomoyuki Koizumi (Product Owner / Architect)

## 1. プロジェクト概要 & コンセプト

- **システム名:** EPM Note Engine (Code Name: ValueCruise)
    
- **目的:** 経営管理SaaS「EPM」の認知獲得・リード創出のため、高品質なNote記事を半自動生成し、投稿負荷を極限まで下げる。
    
- **コアアーキテクチャ:** **"Autonomous Marketing RAG with Last-Mile Automation"**
    
    - **SEO & Quality:** 競合分析と自己推敲（Self-Correction）により、検索上位を狙える品質を担保。
        
    - **Asset Management:** ユーザーの暗黙知（失敗談・画像・音声）を構造化データとして資産化。
        
    - **Full Automation:** 記事作成だけでなく、SNS投稿文の生成からNoteへの下書き保存までを自動化。
        

## 2. 技術スタック & インフラストラクチャ

- **Frontend:** Streamlit (Python 3.10+)
    
- **Backend Logic:** Python, LangChain, **LangGraph** (Stateful Workflow)
    
- **Automation:** **Playwright** (Headless Browser for Note Upload)
    
- **Database (RDB):** **PostgreSQL 15+** (Docker Compose)
    
- **Vector Database:** **ChromaDB** (Persistent Client)
    
- **ORM:** SQLAlchemy (Async対応推奨)
    
- **AI Model:**
    
    - **Main (Writing/Logic):** Anthropic Claude 3.5 Sonnet
        
    - **Sub (Search/Multimodal):** OpenAI GPT-4o
        
- **External API:** Tavily API (Deep Research & SEO Analysis)
    

## 3. データモデル設計 (Schema Definition)

### 3.1. Relational Database (PostgreSQL)

**Table: `articles` (記事プロジェクト管理)**

_V1.3: `sns_posts`, `is_uploaded` を追加_

|**Column**|**Type**|**Description**|
|---|---|---|
|`id`|UUID (PK)|一意識別子|
|`week_id`|VARCHAR|記事候補ID (例: "Week1-1")|
|`title`|VARCHAR|現在の記事タイトル|
|`target_persona`|VARCHAR|ターゲット読者|
|`seo_keywords`|VARCHAR|狙うメイン検索キーワード|
|`status`|VARCHAR|`PLANNING`, `RESEARCHING`, `WAITING_INPUT`, `DRAFTING`, `REVIEW`, `COMPLETED`|
|`competitor_analysis`|JSONB|SEO分析結果 (URL, 見出し, Content Gap)|
|`research_summary`|TEXT|リサーチ結果要約|
|`outline_json`|JSONB|構成案データ|
|`draft_content_md`|TEXT|生成されたドラフト|
|`final_content_md`|TEXT|完成記事|
|`title_candidates`|JSONB|AI提案タイトル案リスト|
|`image_prompts`|JSONB|図解生成指示リスト|
|**`sns_posts`**|**JSONB**|**SNS用投稿文案 (X, LinkedIn)**|
|`metrics`|JSONB|成果指標 (pv, likes, ctr)|
|`published_url`|VARCHAR|公開後のURL|
|**`is_uploaded`**|**BOOLEAN**|**Noteへの転送完了フラグ (Default: False)**|
|`created_at`|TIMESTAMPTZ|作成日時|
|`updated_at`|TIMESTAMPTZ|更新日時|

**Table: `snippets` (ナレッジ資産)**

|**Column**|**Type**|**Description**|
|---|---|---|
|`id`|UUID (PK)|一意識別子|
|`article_id`|UUID (FK)|関連する記事ID|
|`category`|VARCHAR|`FAILURE`, `OPINION`, `TECH`, `HOOK`|
|`content`|TEXT|ナレッジ本文|
|`attachment_path`|VARCHAR|アップロードファイルのパス|
|`attachment_type`|VARCHAR|`image/png`, `audio/mp3`, `text/plain`|
|`tags`|VARCHAR[]|タグ配列|
|`created_at`|TIMESTAMPTZ|作成日時|

### 3.2. Vector Store (ChromaDB)

1. **Collection: `knowledge_base`**: 社内資料 (PDF/MD)
    
2. **Collection: `archive_index`**: 過去記事 + スニペット
    

## 4. 機能要件 & 処理フロー (Logic Workflow)

### Phase 1: Planning (SEO Strategy)

- **UI:** 記事選択時に「SEOキーワード」を入力・確定。
    

### Phase 2: Hybrid Research & SEO Analysis

- **Agent:** Tavilyで競合上位記事を分析 ＋ 社内資料検索。
    
- **Output:** 「競合に勝つ構成案」と「情報のGap」を生成。
    

### Phase 3: Essence Injection (Multimodal)

- **UI:** AI分析結果を見ながら、テキスト入力および**画像/音声ファイルのドラッグ＆ドロップ**でエッセンスを注入。
    

### Phase 4: Drafting, Review & SNS Gen (Loop)

- **LangGraph Nodes:**
    
    1. **Drafting:** 記事執筆、図解指示生成、**SNS投稿文生成**。
        
    2. **Reviewer (New):** 生成された記事を評価。「ターゲットに刺さるか」「論理破綻はないか」をチェック。
        
    3. **Correction Loop:** スコアが低い場合、修正指示を持って `Drafting` へ戻す（最大1回）。
        

### Phase 5: Finalize & Automation (Last Mile)

- **UI:**
    
    - エディタ画面で記事を修正・保存。
        
    - **「Noteへ下書き保存」ボタン**を表示。
        
- **Automation (Playwright):**
    
    - ボタン押下でヘッドレスブラウザが起動。
        
    - Noteへログイン → 「投稿」 → タイトル・本文入力 → 画像アップロード → **「下書き保存」**。
        
    - 完了後、成功メッセージを表示し `is_uploaded` をTrueにする。
        

## 5. ディレクトリ構造

Plaintext

```
epm-note-engine/
├── .env.example             # 環境変数 (NOTE_EMAIL, NOTE_PASSWORD含む)
├── docker-compose.yml       # PostgreSQL, pgAdmin
├── requirements.txt         # playwright等を追加
├── app.py                   # Streamlit Entry Point
├── config.py                # 設定
├── data/
│   ├── inputs/
│   │   ├── knowledge/       # RAG用資料
│   │   ├── uploads/         # ユーザーアップロード
│   │   └── candidates.md    # 記事候補
│   ├── outputs/             # 完成MD
│   └── chroma_db/           # Vector DB
├── database/
│   ├── models.py            # SQLAlchemy Models (V1.3)
│   └── database.py          # DB Session
├── logic/
│   ├── graph.py             # LangGraph (Reviewer入り)
│   ├── agents.py            # Research, Writer, Reviewer
│   ├── rag.py               # ChromaDB Logic
│   ├── multimodal.py        # Image/Audio Proc
│   └── automation.py        # Playwright Note Uploader (New)
└── ui/
    ├── sidebar.py           # 記事選択
    ├── input_form.py        # Essence UI
    ├── editor.py            # Editor & Upload Button
    └── components.py        # 共通部品
```


graph TD
    %% User Interface Layer
    subgraph UI [Streamlit UI]
        Input[記事選択 & SEO KW設定]
        Essence[エッセンス注入<br>Txt/Img/Audio]
        Editor[エディタ & SNS確認]
        BtnUpload[Note転送ボタン]
    end

    %% Logic Layer (LangGraph)
    subgraph AI_Workflow [LangGraph Agent Workflow]
        direction TB
        NodeResearch[<b>Research_SEO</b><br>競合分析 + 社内知見]
        NodeDraft[<b>Drafting</b><br>執筆 + SNS文 + 図解指示]
        NodeReview[<b>Reviewer</b><br>品質スコアリング]
        
        NodeResearch --> Input
        Input --> Essence
        Essence --> NodeDraft
        NodeDraft --> NodeReview
        NodeReview -- < 80点 --> NodeDraft
        NodeReview -- OK --> Editor
    end

    %% Automation Layer
    subgraph Automation [Automation Module]
        Playwright[<b>Playwright</b><br>Note自動操作]
    end

    %% Data Layer
    subgraph Data [Database & Assets]
        DB[(<b>PostgreSQL</b><br>Articles / Snippets)]
        Vector[(<b>ChromaDB</b><br>Knowledge / Archive)]
        Web((Tavily<br>Web Search))
    end

    %% Data Flow
    Input --> DB
    Essence --> DB
    Web <--> NodeResearch
    Vector <--> NodeResearch
    DB <--> NodeDraft
    Editor --> DB
    BtnUpload --> Playwright
    Playwright --> Note[Note.com<br>下書き保存]